<!-- dynamic html page for all the books stored in the database -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ book.title }}</title>

    {% load static %}

    <!-- Stylesheets -->
    <link rel="stylesheet" href="{% static 'css/Common.css' %}">
    <link rel="stylesheet" href="{% static 'css/NavigationBarStyle.css' %}">
    <link rel="stylesheet" href="{% static 'css/alert.css' %}">
    <link rel="stylesheet" href="{% static 'css/popupBox.css' %}">
    <link rel="stylesheet" href="{% static 'css/Buttons.css' %}">
    <link rel="stylesheet" href="{% static 'css/BooksDescriptions.css' %}">
    <link rel="stylesheet" href="{% static 'css/darkMode.css' %}">
    <link rel="icon" href="../static/images/icon.png">

    <script src="https://kit.fontawesome.com/f5a1817204.js" crossorigin="anonymous"></script>
    <script src="{% static 'js/borrow_book.js' %}" defer></script>
    <script src="{% static 'js/darkMode.js' %}"></script>
</head>

<body class="bodySecond" data-book-title="{{ book.title }}">

<!-- Dark Mode Toggle Button -->
<button class="dark-mode-toggle" title="Switch to Dark Mode">
    <i class="fas fa-moon"></i>
</button>

<!-- Navigation bar -->
<div id="navbar" class="side_Nav"></div>
    <script>
        var userRole = "{{ user_role }}";
    </script>
    <script src="{% static 'js/navigation.js' %}"></script>

<!-- Book Image -->
<div class="container">
    <div class="book-cover-container">
        <img src="{{ book.image.url }}" alt="Book Cover" class="imgSize">
        <i class="fas fa-heart favorite-heart" id="favoriteHeart" data-book-id="{{ book.id }}"></i>
    </div>
</div>

<!-- Book Details -->
<div class="rightAlign">
    <div style="margin-left: -50px" id="alertContainer" class="custom-alert"></div>
    <h3 id="Title">{{ book.title }}</h3>
    <h3 id="Author">{{ book.author }}</h3>
    <h3 id="Description">{{ book.description }}</h3>

    <!-- change the status of the borrow button if the book is borrowed-->
    {% if not book.is_borrowed %}
    <form method="POST" class="borrow-form">
        {% csrf_token %}
        <button class="borrow-button" id="borrow_button" data-book-id="{{ book.id }}">
            Borrow Book
        </button>
    </form>
    {% else %}
        <button class="borrowed-button" disabled>Borrowed</button>
    {% endif %}
</div>

<!-- Confirmation Popup -->
<div id="confirmPopup" class="popup-overlay hidden">
    <div class="popup-box">
        <p id="confirmMessage">Are you sure you want to borrow?</p>
        <div class="popup-buttons">
            <button id="confirmCancel">Cancel</button>
            <button id="confirmYes">Yes</button>
        </div>
    </div>
</div>

<!-- Alert and popup scripts -->
<script src="{% static 'js/alert.js' %}"></script>
<script src="{% static 'js/popBox.js' %}"></script>

<script>
// Heart icon click functionality
// This will update all hearts for this book on the page (if any)
document.addEventListener('DOMContentLoaded', function() {
    const heartIcons = document.querySelectorAll('.favorite-heart[data-book-id]');
    const bookId = heartIcons.length > 0 ? heartIcons[0].getAttribute('data-book-id') : null;
    if (!bookId) return;
    // Fetch favorite status for this book
    fetch(`/favorite-status/${bookId}/`)
        .then(response => response.json())
        .then(data => {
            heartIcons.forEach(function(icon) {
                if (data.is_favorite) {
                    icon.classList.add('clicked');
                    icon.style.color = '#ff4757';
                } else {
                    icon.classList.remove('clicked');
                    icon.style.color = '#ccc';
                }
            });
        });
    heartIcons.forEach(function(heartIcon) {
        heartIcon.addEventListener('click', function(event) {
            fetch(`/toggle-favorite/${bookId}/`, {method: 'POST', headers: {'X-CSRFToken': getCSRFToken()}})
                .then(response => response.json())
                .then(data => {
                    heartIcons.forEach(function(icon) {
                        if (data.status === 'favorited') {
                            icon.classList.add('clicked');
                            icon.style.color = '#ff4757';
                        } else {
                            icon.classList.remove('clicked');
                            icon.style.color = '#ccc';
                        }
                    });
                });
            event.stopPropagation();
        });
    });
});
// Helper to get CSRF token from cookies
function getCSRFToken() {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, 10) === ('csrftoken=')) {
                cookieValue = decodeURIComponent(cookie.substring(10));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

</body>
</html>
